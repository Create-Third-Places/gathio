{{#if eventHasCoverImage}}
	<div id="eventImageContainer" style="background-image: url(/events/{{eventData.image}});"></div>
{{else}}
	<div id="genericEventImageContainer" style="background-image: url(/images/seigaiha.png);"></div>
{{/if}}
<div class="row">
	<div class="col-lg">
		<h3 id="eventName">{{eventData.name}}</h3>
	</div>
	{{#if editingEnabled}}
	<div class="col-lg-2 text-right">
		<div class="btn-group" role="group" aria-label="Event controls">
			<button type="button" id="editEvent" class="btn btn-success" data-toggle="modal" data-target="#editModal"><i class="fas fa-pencil-alt"></i></button>
			<button type="button" id="deleteEvent" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal"><i class="fas fa-trash"></i></button>
		</div>
	</div>
	{{/if}}
</div>
<div class="card mt-4 mb-4">
  <div class="card-body">
  	<ul class="fa-ul eventInformation">
			<li>
				<span class="fa-li">
					<i class="fas fa-map-marker-alt"></i>
				</span>
				{{eventData.location}}
				<a href="http://maps.google.com/?q={{parsedLocation}}" class="eventInformationAction btn btn-outline-secondary btn-sm">
					<i class="fas fa-map-marker-alt"></i> Find on Google Maps
				</a>
			</li>
			{{#if eventHasHost}}
				<li>
					<span class="fa-li">
						<i class="fas fa-fw fa-user-circle"></i>
					</span>
					<span class="text-muted">Hosted by</span> {{eventData.hostName}}
				</li>
			{{/if}}
			<li>
				<span class="fa-li">
					<i class="far fa-fw fa-calendar-alt"></i>
				</span>
				{{{displayDate}}}
				<a href="http://www.google.com/calendar/event?action=TEMPLATE&dates={{parsedStart}}%2F{{parsedEnd}}&text={{escapedName}}&location={{parsedLocation}}" class="eventInformationAction btn btn-outline-secondary btn-sm">
					<i class="far fa-calendar-plus"></i> Add to Google Calendar
				</a>
				<br>
				<span class="text-muted">
					{{fromNow}}
				</span>
			</li>
			{{#if eventData.url}}
				<li>
					<span class="fa-li">
						<i class="fas fa-link"></i>
					</span>
					<a href="{{eventData.url}}">
						{{eventData.url}}
					</a>
				</li>
			{{/if}}
			<li>
				<span class="fa-li">
					<i class="fas fa-share-square"></i>
				</span>
				<a href="https://gath.io/{{eventData.id}}">
					gath.io/{{eventData.id}}
				</a>
				<button type="button" id="copyEventLink" class="eventInformationAction btn btn-outline-secondary btn-sm" data-clipboard-text="https://gath.io/{{eventData.id}}">
					<i class="fas fa-copy"></i> Copy
				</button>
			</li>
  	</ul>
	</div>
</div>
{{#if eventHasConcluded}}
<div class="alert alert-warning mb-4" role="alert">
  This event has concluded. It will be automatically deleted <span class="daysToDeletion"></span>.
</div>
{{/if}}
{{#if firstLoad}}
<div class="alert alert-success alert-dismissible fade show" role="alert">
	<button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
	Welcome to your event! We've just sent you an email with your secret editing link, which you can also see in the address bar above. Haven't got the email? Check your spam or junk folder. To share your event, use the link you can see just above this message - that way your attendees won't be able to edit or delete your event!
</div>
{{/if}}
<div class="card mb-4" id="eventDescription">
	<h5 class="card-header">About</h5>
	<div class="card-body">
		{{{parsedDescription}}}
	</div>
</div>

{{#if eventData.usersCanAttend}}
<div class="card mb-4" id="eventAttendees">
	<h5 class="card-header" style="width:100%;display:flex;justify-content:space-between;align-items:center">Attendees {{#if eventData.attendees}}({{eventData.attendees.length}}){{/if}}<button type="button" id="attendEvent" class="btn btn-primary" data-toggle="modal" data-target="#attendModal"><i class="fas fa-user-plus"></i> I'm going!</button></h5>
	<div class="card-body">
		{{#if eventData.attendees}}
			<ul class="attendeesList">
				{{#each eventData.attendees}}
					<li>{{this.name}}</li>
				{{/each}}
			</ul>
		{{else}}
			<p class="text-center text-muted mb-0">No attendees yet!</p>
		{{/if}}
	</div>
</div>

<div class="modal fade" id="attendModal" tabindex="-1" role="dialog" aria-labelledby="attendModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attendModalLabel">Add yourself to '{{eventData.name}}'</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="attendEventForm" action="/attendevent/{{eventData.id}}" method="post">
			<div class="modal-body">
				<div class="form-group row">
					<label for="attendeeName" class="col-sm-2 col-form-label">Your name</label>
					<div class="form-group col-sm-10">
						<input type="text" class="form-control" id="attendeeName" name="attendeeName" placeholder="Or an alias, perhaps..." data-validation="required length" data-validation-length="3-16">
					</div>
				</div>
				<div class="form-group row">
					<label for="attendeeEmail" class="col-sm-2 col-form-label">Your email</label>
					<div class="form-group col-sm-10">
						<input type="email" class="form-control" id="attendeeEmail" name="attendeeEmail" placeholder="We won't spam you <3" data-validation="email" data-validation-optional="true">
						<small class="form-text">Optional - we'll use it to send you any updates to the event.</small>
					</div>
				</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Add myself</button>
      </div>
      </form>
    </div>
  </div>
</div>
{{/if}}

{{#if eventData.usersCanComment}}
<div class="card mb-4" id="eventComments">
	<h5 class="card-header">Discussion</h5>
	<div class="card-body">
		<form id="commentForm" action="/post/comment/{{eventData.id}}/" method="post">
			<div class="form-group">
				<input type="text" class="form-control" id="commentAuthor" name="commentAuthor" placeholder="Your name" data-validation="required length" data-validation-length="3-60">
			</div>
			<div class="form-group">
				<div class="input-group">
					<textarea class="form-control" id="commentContent" name="commentContent" style="resize: none;" placeholder="What would you like to ask?" data-validation="required length" data-validation-length="3-280"></textarea>
					<div class="input-group-append">
						<button type="submit" class="btn btn-primary btn-block h-100" id="postComment">Send <i class="fas fa-chevron-right"></i></button>
					</div>
				</div>
			</div>
		</form>
		{{#if eventData.comments}}
			<hr style="border-style:dashed;">
			<div class="container commentsList">
			{{#each eventData.comments}}
				<div class="comment">
					<div class="row commentContainer">
						<div class="col-lg commentText">
							<p class="mb-0"><strong>{{this.author}}</strong> <small class="commentTimestamp text-muted">{{this.timestamp}}</small></p>
							<p>{{this.content}}</p>
							{{#if this.replies}}
								<hr>
								<div class="repliesContainer">
									{{#each this.replies}}
										<p class="mb-0"><strong><i class="fas fa-reply text-muted"></i> {{this.author}}</strong> <small class="commentTimestamp text-muted">{{this.timestamp}}</small></p>
										<p>{{this.content}}</p>
									{{/each}}
								</div>
							{{/if}}
						</div>
						<div class="col-lg-3 commentMetadata text-right">
							<button type="button" class="btn btn-outline-primary btn-sm openReplyBox">
								<i class="fas fa-comment"></i> Reply
							</button>
							{{#if ../editingEnabled}}
								<form class="d-inline" action="/deletecomment/{{../eventData.id}}/{{this._id}}/{{../eventData.editToken}}" method="post">
									<button type="submit" class="btn btn-outline-danger btn-sm deleteComment">
										<i class="fas fa-trash"></i> Delete
									</button>
								</form>
							{{/if}}
						</div>
					</div>
					<div class="row replyContainer">
						<div class="col-md">
							<form id="replyForm" action="/post/reply/{{../eventData.id}}/{{this._id}}" method="post">
								<div class="form-group">
									<input type="text" class="form-control form-control-sm" id="replyAuthor" name="replyAuthor" placeholder="Your name" data-validation="required length" data-validation-length="3-60">
								</div>
								<div class="form-group">
									<div class="input-group">
										<textarea class="form-control form-control-sm" id="replyContent" name="replyContent" style="resize: none;" placeholder="What would you like to reply?" data-validation="required length" data-validation-length="3-280"></textarea>
										<div class="input-group-append">
											<button type="submit" class="btn btn-primary btn-block h-100 btn-sm" id="postReply">Reply <i class="fas fa-chevron-right"></i></button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			{{/each}}
			</div>
		{{/if}}
	</div>
</div>
{{/if}}

{{#if editingEnabled}}
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit '{{eventData.name}}'</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="editEventForm" action="/editevent/{{eventData.id}}/{{eventData.editToken}}" method="post" enctype="multipart/form-data">
			<div class="modal-body">
				<div class="form-group row">
					<label for="eventName" class="col-sm-2 col-form-label">Event name</label>
					<div class="form-group col-sm-10">
						<input type="text" class="form-control" id="eventName" name="eventName" placeholder="Make it snappy." value="{{eventData.name}}" data-validation="required length" data-validation-length="3-60">
					</div>
				</div>
				<div class="form-group row">
					<label for="eventLocation" class="col-sm-2 col-form-label">Location</label>
					<div class="form-group col-sm-10">
						<input type="text" class="form-control" id="eventLocation" name="eventLocation" placeholder="Be specific." value="{{eventData.location}}" data-validation="required length"  data-validation-length="3-60">
					</div>
				</div>
				<div class="form-group row">
					<label for="eventStart" class="col-sm-2 col-form-label">Starts</label>
					<div class="form-group col-sm-10">
						<input readonly type="text" class="form-control" id="eventStart" name="eventStart"  value="" data-validation="required">
					</div>
				</div>
				<div class="form-group row">
					<label for="eventEnd" class="col-sm-2 col-form-label">Ends</label>
					<div class="form-group col-sm-10">
						<input readonly type="text" class="form-control" id="eventEnd" name="eventEnd" value="" data-validation="required">
					</div>
				</div>
				<div class="form-group row">
					<label for="eventDescription" class="col-sm-2 col-form-label">Description</label>
					<div class="form-group col-sm-10">
						<textarea class="form-control" id="eventDescription" name="eventDescription" data-validation="required">{{eventData.description}}</textarea>
						<small class="form-text"><a href="https://commonmark.org/help/">Markdown</a> formatting supported.</small>
					</div>
				</div>
				<div class="form-group row">
					<label for="eventURL" class="col-sm-2 col-form-label">Link</label>
					<div class="form-group col-sm-10">
						<input type="url" class="form-control" id="eventURL" name="eventURL" value="{{eventData.url}}" placeholder="For tickets or another event page (optional)." data-validation="url" data-validation-optional="true">
					</div>
				</div>
				<div class="form-group row">
					<label for="hostName" class="col-sm-2 col-form-label">Host name</label>
					<div class="form-group col-sm-10">
						<input type="text" class="form-control" id="hostName" name="hostName" placeholder="Will be shown on the event page (optional)." value="{{eventData.hostName}}" data-validation="length" data-validation-length="3-60" data-validation-optional="true">
					</div>
				</div>
				<div class="form-group row">
					<label for="eventImage" class="col-sm-2 col-form-label">Cover image</label>
					<div class="form-group col-sm-10">
						<div id="image-preview">
							<label for="image-upload" id="image-label">Choose file</label>
							<input type="file" name="imageUpload" id="image-upload" />
						</div>
						<small class="form-text">Recommended dimensions (w x h): 920px by 300px.</small>
					</div>
				</div>
     		<div class="form-group row">
					<div class="col-sm-2">Options</div>
					<div class="col-sm-10">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" id="joinCheckbox" name="joinCheckbox" {{#if eventData.usersCanAttend}}checked{{/if}}>
							<label class="form-check-label" for="joinCheckbox">
								Users can mark themselves as attending this event
							</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" id="interactionCheckbox" name="interactionCheckbox" {{#if eventData.usersCanComment}}checked{{/if}}>
							<label class="form-check-label" for="interactionCheckbox">
								Users can post comments on this event
							</label>
						</div>
					</div>
				</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete '{{eventData.name}}'</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="editEventForm" action="/deleteevent/{{eventData.id}}/{{eventData.editToken}}" method="post">
			<div class="modal-body">
				<p>Are you sure you want to delete this event? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-danger">Delete event</button>
      </div>
      </form>
    </div>
  </div>
</div>

{{/if}}


<script>
	$.validate({
    lang: 'en',
		errorElementClass: "is-invalid",
		errorMessageClass: "text-danger",
		successElementClass: "is-valid"
  });
	{{#if editingEnabled}}
	$('#eventStart').datepicker({
    language: 'en',
    minDate: new Date(),
		timepicker: true,
		dateFormat: 'd MM yyyy',
		dateTimeSeparator: ', ',
		onSelect: function(formattedDate, rawDate){
			$('#eventEnd').datepicker().data('datepicker').update('minDate', rawDate).clear();
		}
	});
	$('#eventEnd').datepicker({
    language: 'en',
    minDate: new Date(),
		timepicker: true,
		dateFormat: 'd MM yyyy',
		dateTimeSeparator: ', '
	});
	{{/if}}
	$(".commentTimestamp").html(function(){
		parsedDate = moment($(this).html()).fromNow();
		return parsedDate;
	});
	$(".openReplyBox").click(function(){
//		let replyID = $(this).attr("data-id");
		$(this).closest(".comment").find(".replyContainer").slideToggle();
	})
	$(document).ready(function() {
		$.uploadPreview({
			input_field: "#image-upload",
			preview_box: "#image-preview",
			label_field: "#image-label",
			label_default: "Choose file",
			label_selected: "Change file",
			no_label: false
		});
		$("#image-preview").css("background-image", "url('/events/{{eventData.image}}')");
		$("#image-preview").css("background-size", "cover");
		$("#image-preview").css("background-position", "center center");
		{{#if editingEnabled}}
		$('#eventStart').datepicker().data('datepicker').selectDate(moment('{{parsedStart}}', 'YYYYMMDD[T]HHmmss').toDate());
		$('#eventEnd').datepicker().data('datepicker').selectDate(moment('{{parsedEnd}}', 'YYYYMMDD[T]HHmmss').toDate());
		{{/if}}
		new ClipboardJS('#copyEventLink');
		autosize($('textarea'));
		$("#copyEventLink").click(function(){
			$(this).html('<i class="fas fa-copy"></i> Copied!');
			setTimeout(function(){ $("#copyEventLink").html('<i class="fas fa-copy"></i> Copy');}, 5000);
		})
		$(".daysToDeletion").html(moment("{{eventData.end}}").add('days', 7).fromNow());
	});

	</script>
